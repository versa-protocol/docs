---
title: "Sending a Receipt"
---

# Sending a Receipt

Receipt senders are merchants or merchant service providers — E-commerce websites, online booking tools, hotel chains, etc. — who wish to pass receipts through to their customers.

Senders first need to pick how they'd like to send receipts:

1. Via a **[custodial configuration](#custodial-configuration)**: With this arrangement, sending a receipts is as simple as a standard HTTP POST request, via a RESTful API. The sender makes a single call per receipt, passing up the receipt JSON to Versa.
2. Via a **[self-hosted configuration](#self-hosted-configuration)**: With this arrangement, the sender never sends Versa the receipt. Instead, they check Versa for registered customers, and handle the encryption and peer-to-peer receipt transfer directly.

The custodial configuration is typically easier. The self-hosted configuration, on the other hand, removes the need to trust a third-party (Versa) with the receipt data. At any point you can 'eject' from a custodial to a self-hosted configuration. Most developers choose this path.

## Getting Started

Before you can send your first receipt, you’ll need to [create an account](https://app.versa.org) on Versa.

Youl will then need to adapt your internal sales data to Versa's [Receipt Schema](/receipt-schema). Versa offers several different templates for different types of receipts. Configure your merchant name, logo, and brand color on the [Profile](https://app.versa.org/profile) settings screen, and then prototype and preview your full, branded receipts in the [Studio](https://app.versa.org/studio).

## Custodial Configuration

When you [create your client](https://app.versa.org/client) in the Versa web app, you'll need to select that you are a 'Sender' and that you'd like to enable the 'Custodial' mode. Once you create your custodial sender client, copy your Client Secret and save it someplace safe.

You're now ready to send your first receipt. Add your Client ID, Client Secret, the email domain of your customer, and a valid Versa receipt JSON object. For test sending, you can use 'sandbox-firehose.versa.org' as the `customer_email_domain`. Read the [Testing](#testing-your-connection) for more details.

```bash
curl --request POST \
  --url 'https://custodial.versa.org/sender/target' \
  --header 'Authorization: Basic <CLIENT_ID:CLIENT_SECRET>' \
  --header 'Content-Type: application/json' \
  --data '{
  "handles": {
    "customer_email_domain": "CUSTOMER_EMAIL_DOMAIN"
  },
  "receipt": { ... }'
```

Congratulations! You've sent your first receipt.

## Self-hosted Configuration

Ready to implement a full 'self-hosted' Versa sender client? This configuration is similar to the [Custodial](#custodial-configuration) approach, but rather than sending your receipts to Versa, the Versa Registry tells you where to send the receipts, and you handle the encryption and sending on your own. There are three steps:

1. [Register the Transaction](#1-register-the-transaction)
2. [Encrypt the Receipt](#2-encrypt-the-receipt)
3. [Send the Receipt](#3-send-the-receipt)

### 1. Register the Transaction

Upon completing a sale, you'll want to register the transaction with Versa. You'll pass up a customer handle, and Versa will return the addresses of any authorized receivers.

The only valid customer handle type at the moment is a `customer_email_domain` — in the future, we will add others.

```bash
curl --request POST \
  --url 'https://registry.versa.org/register' \
  --header 'Authorization: Basic <CLIENT_ID:CLIENT_SECRET>' \
  --header 'Content-Type: application/json' \
  --data '{
    "receipt_hash": 175932758392347,
    "schema_version": "1.0.0",
    "handles": {
      "customer_email_domain": "acme.com"
    }
  }'
```

| Field            | Type      | Description                                                                                 |
| ---------------- | --------- | ------------------------------------------------------------------------------------------- |
| `receipt_hash`   | `integer` | ...                                                                                         |
| `schema_version` | `string`  | The version of your sender client.                                                          |
| `handles`        | `object`  | The customer identifier. For now the only supported handle type is `customer_email_domain`. |

Example response:

```json
{
  "env": "prod",
  "encryption_key": [ ... ],
  "receipt_id": "rct_5ed073abbf3a4b49a8c03191f87d8ffe",
  "transaction_id": "txn_458a58b2dd7a4fe3a9ad3165a511ac2a",
  "receivers": [
    {
      "address": "https://bank.com/receipt",
      "client_id": "versa_cid_prod_9c014de1835a46de8d3e1fd54547dd29",
      "org_id": "org_39a0e09cf0a24b02ba92bf8c8369b319",
      "secret": "versa_rsk_prod_d9362d18f76845afb4c75b8388d2e549"
    },
    {
      "address": "https://expenseapp.com/receipt",
      "client_id": "versa_cid_prod_5410222b17fa4a4e865e19aebcd77cba",
      "org_id": "org_df8d2ce28f6e48afb2dfe4af0c57788f",
      "secret": "versa_rsk_prod_56781edd14ba47a4938e252b0c3932ee"
    }
  ]
}
```

If there are no authorized receivers for the given handles, Versa will return an empty array.

### 2. Encrypt the Receipt

Receipts are encrypted with the AES 256 encryption algorithm, using the registry-provided key and a unique nonce generated for each receiver.

### 3. Send the Receipt

For each receiver, generate an HMAC verification token using their receiver secret. 
The nonce and encrypted data are then sent to each receiver address, at which point the receiver will check out the key from the registry and decrypt the envelope.

```bash
curl --request POST \
  --url 'https://expenseapp.com/receipt' \
  --header 'X-Request-Signature: <HMAC_TOKEN>' \
  --header 'Content-Type: application/json' \
  --data '{
    "sender_client_id": "versa_cid_prod_3633863a5e5d417eb723124b387ec929",
    "receipt_id": "rct_5ed073abbf3a4b49a8c03191f87d8ffe",
    "envelope": {
      "encrypted": [...],
      "hash": 175932758392347,
      "nonce": [...]
    }
  }'
```

## Updating a Receipt

You may, on occasion, want to update a receipt e.g. to include a tip or refund. Updating a receipt is similar to registering a new receipt. The only difference is that the original `transaction_id` returned by the registry is now included in the 'update' registration request.

For example:

```bash
curl --request POST \
  --url 'https://registry.versa.org/register' \
  --header 'Authorization: Basic <CLIENT_ID:CLIENT_SECRET>' \
  --header 'Content-Type: application/json' \
  --data '{
    "receipt_hash": 923232454472219,
    "transaction_id": "txn_458a58b2dd7a4fe3a9ad3165a511ac2a",
    "schema_version": "1.0.0",
    "handles": {
      "customer_email_domain": "acme.com"
    }
  }'
```

This will associate the new receipt record with the original receipt.

## Testing Your Integration

You can test that your receipts conform to the Versa JSON [Receipt Schema](/receipt) using the [Studio](https://app.versa.org/studio).

Once you are ready to send receipts, you can test your configuration by using test client credentials and our sandbox receiver. The sandbox receiver is a client that only accepts receipts in test, and exposes those receipts to any authorized user via the [Sandbox Firehose](https://app.versa.org/sandbox-firehose).

> [!WARNING]  
> Please be aware that the Sandbox Firehose page is accessible to any user of the Versa web app. Do not send production or sensitive data to the sandbox.

To send a receipt to the sandbox, ensure that you use the following domain in your receipt's routing data: `sandbox-firehose.versa.org`.

For example, with a fully implemented self-hosted client:

```bash
curl --request POST \
  --url 'https://registry.versa.org/register' \
  --header 'Authorization: Basic <CLIENT_ID:CLIENT_SECRET>' \
  --header 'Content-Type: application/json' \
  --data '{
    "receipt_hash": 555232454472219,
    "schema_version": "1.0.0",
    "handles": {
      "customer_email_domain": "sandbox-firehose.versa.org"
    }
  }'
```

...or if you are starting with a custodial sender:

```bash
curl --request POST \
  --url 'https://custodial.versa.org/sender/target' \
  --header 'Authorization: Basic <CLIENT_ID:CLIENT_SECRET>' \
  --header 'Content-Type: application/json' \
  --data '{
  "handles": {
    "customer_email_domain": "sandbox-firehose.versa.org"
  },
  "receipt": { ... }
}'
```

After registering your test receipt (and sending the encrypted payload to the matched receiver), you can view the receipt using the [Sandbox Firehose](https://app.versa.org/sandbox-firehose).
