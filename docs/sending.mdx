---
title: "Sending a Receipt"
---

# Sending a Receipt

Receipt senders are merchants (E-commerce websites, online booking tools, hotel chains, etc.) who wish to pass receipts through to their customers.

## Getting Started

Before you can send your first receipt, you’ll need to [create an account](https://app.versa.org) on Versa.

Then, as you make sales, you'll check if the customers you're selling to are registered to receive receipts. When Versa returns a positive customer match, you'll send them the itemized receipt object.

The receipt object itself must conform to Versa's [Receipt Schema](/receipt). The schema offers a range of template types and formatting options to best represent the goods and services you sell; you'll map from your internal purchase data accordingly. Configure your merchant name, logo, and brand color on the [Profile](https://app.versa.org/profile) settings screen, and then prototype and preview your full, branded receipts in the [Studio](https://app.versa.org/studio).

![A screenshot of the Versa Studio.](https://raw.githubusercontent.com/versa-protocol/docs/main/assets/studio-screenshot.png)

## Sending Receipts

When you're ready to send receipts, there are two configuration options to pick from:

1. Via a **[custodial configuration](#custodial-configuration)**: With this arrangement, sending a receipt is as simple as a standard HTTP POST request, via a RESTful API. The sender makes a single call per receipt, passing up the receipt JSON to Versa.
2. Via a **[self-hosted configuration](#self-hosted-configuration)**: With this arrangement, the sender never sends Versa the receipt. Instead, they check Versa for registered customers, and manage the encryption and peer-to-peer receipt transfer directly.

The custodial configuration is typically a faster implementation; the self-hosted configuration gives you more control. At any point you can 'eject' from a custodial to a self-hosted configuration. Most developers start with a custodial configuration during development, then switch to self-hosted.

### Custodial Configuration

When you [create your client](https://app.versa.org/client) in the Versa web app, select that you are a 'Sender' and that you'd like to enable the 'Custodial' mode. Then copy your Client Secret and save it someplace safe.

You're now ready to send your first receipt. Add your Client ID, Client Secret, the email domain of your customer, and a Versa receipt object.

```bash
curl --request POST \
  --url 'https://custodial.versa.org/sender/target' \
  --header 'Authorization: Basic CLIENT_ID:CLIENT_SECRET' \
  --header 'Content-Type: application/json' \
  --data '{
    "handles": {
      "customer_email": "jshmoe@acme.com"
    },
    "receipt": { ... }
  }'
```

For test sending, you can provide 'sandbox-firehose.versa.org' as the `customer_email_domain` handle (or provide a full `customer_email` with any username, e.g. `jshmoe@sandbox-firehose.versa.org`) and you can copy one of the sample receipts from the [receipt schema documentation](/receipt). Read the [testing section](#testing-your-integration) for more details.

Congratulations! You've sent your first receipt.

### Self-Hosted Configuration

Ready to implement a full 'self-hosted' Versa sender client? This configuration is similar to the [custodial](#custodial-configuration) approach, but rather than sending your receipts to Versa, the Versa Registry tells you where to send the receipts, and you handle the encryption and sending on your own.

There are three steps:

1. **[Register the Transaction](#1-register-the-transaction)**
2. **[Encrypt the Receipt](#2-encrypt-the-receipt)**
3. **[Send the Receipt](#3-send-the-receipt)**

You'll first need an active sending [client](https://app.versa.org/client).

> [!TIP]
> If you already have an active client that you've been using in a custodial configuration, you can continue to use those same keys in a self-hosted configuration.

#### 1. Register the Transaction

Upon completing a sale, you'll want to register the transaction with Versa. You'll pass up a customer handle (e.g. the customer email address), and Versa will match that handle with any authorized receivers. If there are matched receivers, Versa will return the url indicating where to post the receipt.

Versa supports four different handle types: `customer_email`, `customer_email_domain`, `card_bin`, `card_last_four`. You must send at least one handle, and up to the full set of four. Versa will return matches for any of the handles, with the exception of `card_last_four` (as `card_last_four` is never unique).

```bash
curl --request POST \
  --url 'https://registry.versa.org/register' \
  --header 'Authorization: Basic CLIENT_ID:CLIENT_SECRET' \
  --header 'Content-Type: application/json' \
  --data '{
    "schema_version": "1.0.0",
    "handles": {
      "customer_email_domain": "acme.com"
    }
  }'
```

| Field            | Type     | Description                                           |
| ---------------- | -------- | ----------------------------------------------------- |
| `schema_version` | `string` | The schema version of the receipt that you will send. |
| `handles`        | `object` | The customer [handle](#handle-object).                |

##### Handle Object

| Field                   | Type              | Description                                                                                                                                                                              |
| ----------------------- | ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `customer_email`        | `nullable string` | E.g. 'jshmoe@acme.com'.                                                                                                                                                                  |
| `customer_email_domain` | `nullable string` | E.g. 'acme.com'.                                                                                                                                                                         |
| `card_bin`              | `nullable string` | The first 4-8 digits of a card number, identifying the financial institution that issued the card. E.g. 412345. This is useful only when there is a 1:1 mapping of card bin to receiver. |
| `card_last_four`        | `nullable string` | The last four digits of a card number. Unlike the other handles, 'last four' is only used as a supporting value, as it is not unique to a customer or platform.                          |

Example response:

```json
{
  "env": "prod",
  "encryption_key": [ ... ],
  "receipt_id": "rct_5ed073abbf3a4b49a8c03191f87d8ffe",
  "transaction_id": "txn_458a58b2dd7a4fe3a9ad3165a511ac2a",
  "receivers": [
    {
      "address": "https://bank.com/receipt",
      "client_id": "versa_cid_prod_9c014de1835a46de8d3e1fd54547dd29",
      "org_id": "org_39a0e09cf0a24b02ba92bf8c8369b319",
      "secret": "versa_rsk_prod_d9362d18f76845afb4c75b8388d2e549"
    },
    {
      "address": "https://expenseapp.com/receipt",
      "client_id": "versa_cid_prod_5410222b17fa4a4e865e19aebcd77cba",
      "org_id": "org_df8d2ce28f6e48afb2dfe4af0c57788f",
      "secret": "versa_rsk_prod_56781edd14ba47a4938e252b0c3932ee"
    }
  ]
}
```

| Field            | Type     | Description                                                                    |
| ---------------- | -------- | ------------------------------------------------------------------------------ |
| `env`            | `enum`   | One of `test` or `prod`.                                                       |
| `encryption_key` | `string` | The key you'll use to encrypt your receipt.                                    |
| `receipt_id`     | `string` | The id of the specific receipt being sent.                                     |
| `transaction_id` | `string` | The parent of the receipt — used for [updating receipts](#updating-a-receipt). |
| `receivers`      | `array`  | A list of [receiver objects](#receiver-object).                                |

##### Receiver Object

| Field       | Type     | Description                                                   |
| ----------- | -------- | ------------------------------------------------------------- |
| `address`   | `string` | The url where you'll post the encrypted receipt.              |
| `client_id` | `string` | The id of the receiving client.                               |
| `org_id`    | `string` | The id of the receiving org (orgs can have multiple clients). |
| `secret`    | `string` | Used for HMAC verification.                                   |

If there are no authorized receivers for the given handles, Versa will return an empty array.

#### 2. Encrypt the Receipt

Receipts are encrypted with the AES 256 encryption algorithm, using the registry-provided key and a unique nonce generated for each receiver.

#### 3. Send the Receipt

For each receiver, generate an HMAC verification token using their receiver secret. The nonce and encrypted data are then sent to each receiver address, at which point the receiver will check out the key from the registry and decrypt the envelope.

```bash
curl --request POST \
  --url 'https://expenseapp.com/receipt' \
  --header 'X-Request-Signature: <HMAC_TOKEN>' \
  --header 'Content-Type: application/json' \
  --data '{
    "sender_client_id": "versa_cid_prod_3633863a5e5d417eb723124b387ec929",
    "receipt_id": "rct_5ed073abbf3a4b49a8c03191f87d8ffe",
    "envelope": {
      "encrypted": [ ... ],
      "nonce": [ ... ]
    }
  }'
```

| Field              | Type     | Description                                                                    |
| ------------------ | -------- | ------------------------------------------------------------------------------ |
| `sender_client_id` | `string` | Your [sender client id](https://app.versa.org/client).                         |
| `receipt_id`       | `string` | The id of the receipt, taken from the [registry response](#registry-response). |
| `envelope`         | `string` | The container for the encrypted receipt and nonce.                             |

## Updating a Receipt

You may, on occasion, want to update a receipt e.g. to include a tip or refund. Updating a receipt is nearly identical to sending a new receipt. The only difference is that the original `transaction_id` returned by the registry is now included in the 'update' registration request.

For example:

```bash
curl --request POST \
  --url 'https://registry.versa.org/register' \
  --header 'Authorization: Basic CLIENT_ID:CLIENT_SECRET' \
  --header 'Content-Type: application/json' \
  --data '{
    "transaction_id": "txn_458a58b2dd7a4fe3a9ad3165a511ac2a",
    "schema_version": "1.0.0",
    "handles": {
      "customer_email_domain": "acme.com"
    }
  }'
```

This will associate the new receipt record with the original receipt.

## Testing Your Integration

You can test that your receipts conform to the Versa JSON [Receipt Schema](/receipt) using the [Studio](https://app.versa.org/studio).

Once you're ready to send receipts, you can test your configuration by using test client credentials and our Sandbox Firehose Receiver. The Sandbox Firehose Receiver only accepts receipts sent via a test client, and exposes those receipts to any authorized user via the [Sandbox Firehose](https://app.versa.org/sandbox-firehose).

> [!WARNING]  
> Please be aware that the Sandbox Firehose page is accessible to all Versa web app users. Do not send production or sensitive data to the sandbox.

To send a receipt to the sandbox, ensure that you use the following domain as your customer email domain handle: "sandbox-firehose.versa.org".

For example, with a fully implemented self-hosted client:

```bash
curl --request POST \
  --url 'https://registry.versa.org/register' \
  --header 'Authorization: Basic CLIENT_ID:CLIENT_SECRET' \
  --header 'Content-Type: application/json' \
  --data '{
    "schema_version": "1.0.0",
    "handles": {
      "customer_email_domain": "sandbox-firehose.versa.org"
    }
  }'
```

...or if you are starting with a custodial sender:

```bash
curl --request POST \
  --url 'https://custodial.versa.org/sender/target' \
  --header 'Authorization: Basic CLIENT_ID:CLIENT_SECRET' \
  --header 'Content-Type: application/json' \
  --data '{
  "handles": {
    "customer_email_domain": "sandbox-firehose.versa.org"
  },
  "receipt": { ... }
}'
```

After registering your test receipt (and sending the encrypted payload to the matched receiver), you can view the receipt using the [Sandbox Firehose](https://app.versa.org/sandbox-firehose).
